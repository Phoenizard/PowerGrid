%%{init: {'theme': 'base', 'themeVariables': {'primaryColor': '#2d3748', 'primaryTextColor': '#fff', 'primaryBorderColor': '#4a5568', 'lineColor': '#718096', 'secondaryColor': '#edf2f7', 'tertiaryColor': '#e2e8f0', 'fontSize': '14px'}}}%%

flowchart TD
    START([ðŸš€ Start]) --> P0

    subgraph P0["Phase 0: Setup"]
        P0A["Create ~/paper_reproduction/"]
        P0B["pip install dependencies"]
        P0C["Extract reference figure from PDF"]
        P0D["Create config.py with all parameters"]
        P0A --> P0B --> P0C --> P0D
    end

    P0 --> P1

    subgraph P1["Phase 1: Write & Execute â€” Claude Code ðŸ–¥ï¸"]
        P1A["Write model.py\n(swing equation, Îº_c bisection)"]
        P1B["Write sweep.py\n(simplex sweep, cross-section)"]
        P1C["Write plot_fig1c.py, plot_fig1d.py\n(visualization)"]
        P1D["Execute via terminal\npython run_all.sh"]
        P1E["Output: fig1c.png, fig1d.png\n+ cached .npz data"]
        P1A --> P1B --> P1C --> P1D --> P1E
    end

    P1 --> P2

    subgraph P2["Phase 2: View & Compare â€” MCP ðŸ‘ï¸"]
        P2A["Open output figure via MCP\n(view PNG on local machine)"]
        P2B["Open reference figure\n(from paper PDF)"]
        P2C["Structured comparison\n10-item checklist per figure"]
        P2D{"All items\nPASS âœ“?"}
        P2A --> P2B --> P2C --> P2D
    end

    P2D -->|"âœ… ALL PASS"| P4
    P2D -->|"âŒ FAIL / PARTIAL"| P3

    subgraph P3["Phase 3: Diagnose & Patch â€” Claude Code ðŸ”§"]
        P3A["List failed checklist items"]
        P3B["Root cause analysis\nfor each failure"]
        P3C["Generate targeted patches\n(only affected files)"]
        P3D["Use cached data if\nonly visual fix needed"]
        P3A --> P3B --> P3C --> P3D
    end

    P3 --> ITER{"Iteration\nâ‰¤ 8?"}
    ITER -->|"Yes"| P1
    ITER -->|"No (max reached)"| BEST["Output best version\n+ discrepancy report"]

    subgraph P4["Phase 4: Final Validation ðŸ"]
        P4A["Generate final at DPI=300\nwith ENSEMBLE=200"]
        P4B["Create side-by-side\ncomparison image"]
        P4C["MCP final review"]
        P4D["âœ… Export final figures"]
        P4A --> P4B --> P4C --> P4D
    end

    P4 --> DONE([ðŸŽ‰ Done])
    BEST --> DONE

    style P0 fill:#4a5568,stroke:#2d3748,color:#fff
    style P1 fill:#2b6cb0,stroke:#2c5282,color:#fff
    style P2 fill:#2f855a,stroke:#276749,color:#fff
    style P3 fill:#c05621,stroke:#9c4221,color:#fff
    style P4 fill:#6b46c1,stroke:#553c9a,color:#fff
    style START fill:#38a169,stroke:#276749,color:#fff
    style DONE fill:#38a169,stroke:#276749,color:#fff
    style BEST fill:#e53e3e,stroke:#c53030,color:#fff
